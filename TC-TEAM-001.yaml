---
- name: TC-TEAM-001 - Verify that the team module creates a team under a given organization in
  hosts: localhost
  gather_facts: false
  vars_files:
    - ./vars/user.yml
    - ./vars/aap.yml

  vars:
    # Change this to your Red Hat username so names are unique
    team_name: "TestTeam-1-{{ rh_username }}"
    org_name: "TestOrg-1-{{ rh_username }}"
  tasks:
    - name: Cleanup
      ansible.builtin.include_tasks: ./reset/TC-TEAM-001.yaml

    - name: Create organization TC-ORG-001
      ansible.platform.organization: &tc_org_001
        name: "{{ org_name }}"
        description: Primary engineering tenant
        state: present
        aap_hostname: "{{ aap_hostname }}"
        aap_username: "{{ aap_username }}"
        aap_password: "{{ aap_password }}"
        aap_validate_certs: false
      register: add_org_first
    
    - name: Create team under org TC-TEAM-001
      ansible.platform.team: &tc_team_001
        name: "{{ team_name }}"
        organization: "{{ org_name }}"
        description: Bangalore site operations
        state: present
        aap_hostname: "{{ aap_hostname }}"
        aap_username: "{{ aap_username }}"
        aap_password: "{{ aap_password }}"
        aap_validate_certs: false
      register: add_team_first

    - name: Assert rename was successful
      ansible.builtin.assert:
        that:
          - add_team_first is changed

    - name: Re-run task to verify idempotency
      ansible.platform.team: *tc_team_001
      register: add_team_idem

    - name: Assert second run is idempotent (no changes)
      ansible.builtin.assert:
        that:
          - add_team_idem is not changed
